tinymce.PluginManager.add('mapshapes', function(editor, url) {
    // Add a button that opens a window
    editor.addButton('mapshapes', {
        text: 'Insert Shapes',
        icon: false,
        onclick: function() {
            // Open window
			var values = [];
			values.push({text: ' [Select] ', value: -1});
			
			if(getLayers) {
				var layers = getLayers();
				$.each(layers, function(index, layer) {
					if(getPropertiesByLayer) {
						props = getPropertiesByLayer(layer);
						var check = false;
						
						$.each(props, function(idx, prop) {
							if(prop.name.toLowerCase() == "location") {
								values.push({text: prop.value, value: index});
								check = true;
							}
						});
						
						if(!check) {
							$.each(props, function(idx, prop) {
								if(prop.name.toLowerCase() == "name") {
									values.push({text: prop.value + '', value: index});
								}
							});
						}
					}
				});
			}
			
            editor.windowManager.open({
                title: 'Shape Link',
                body: [
                    {
						type: 'listbox', 
						name: 'mapshapes', 
						label: 'Select Shape', 
						'values': values
					}
                ],
                onsubmit: function(e) {
                    // Insert content when the window form is submitted
					if(e.data.mapshapes != -1) {
						var text = '';
						$.each(values, function(i, v) {
							if(v.value == e.data.mapshapes) {
								text = v.text;
								return false;
							}
						});
						
						var content = '<a href="#" style="cursor: pointer;" onClick="$(\'#sidebar-buttons ul li a\').eq('+e.data.mapshapes+').click(); return false;">'+text+'</a>';
						editor.insertContent(content);
					}
                }
            });
        }
    });
/*
    // Adds a menu item to the tools menu
    editor.addMenuItem('mapshapes', {
        text: 'Shape Link',
        context: 'tools',
        onclick: function() {
            // Open window with a specific url
            editor.windowManager.open({
                title: 'TinyMCE site',
                url: 'http://www.tinymce.com',
                width: 800,
                height: 600,
                buttons: [{
                    text: 'Close',
                    onclick: 'close'
                }]
            });
        }
    });*/
});